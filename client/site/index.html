<html>
  <head>
    <script type="text/javascript" src="lib/ByteBufferAB.min.js"></script>
    <script type="text/javascript" src="lib/ProtoBuf.min.js"></script>
    <script type="text/javascript" src="js/celestia.js"></script>
  </head>
  <body></body>
  <script>

    var chat = new WebSocket("ws://" + location.hostname + ":8081/action");    
    chat.binaryType = "arraybuffer";
    chat.onopen = function(e) { 

      var celestia = null;
      
      function start(snapshot) {
        celestia = Elm.fullscreen(Elm.Demo, { snapshots : snapshot });
        celestia.ports.controls.subscribe(function(e) {
          console.log("Sending buffer with",e.byteLength,"bytes");
          chat.send(e);
        });
      }

      chat.onmessage = function(event) {
        console.log(event);
        if (celestia) {
          celestia.ports.snapshots.send(event);
        } 
        else {
          start(event);
        }
          
      }

    }

  </script>
</html>
